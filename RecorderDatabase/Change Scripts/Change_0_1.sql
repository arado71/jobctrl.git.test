/*
Deployment script for recorder_temp

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
/*
:setvar DatabaseName "recorder_temp"
:setvar DefaultFilePrefix "recorder_temp"
:setvar DefaultDataPath "D:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "D:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\DATA\"
*/

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Altering [dbo].[ClientSettings]...';


GO
ALTER TABLE [dbo].[ClientSettings]
    ADD [MenuVersion]              BINARY (8) DEFAULT ((0)) NOT NULL,
        [WorkDetectorRulesVersion] BINARY (8) DEFAULT ((0)) NOT NULL,
        [CensorRulesVersion]       BINARY (8) DEFAULT ((0)) NOT NULL,
        [ClientSettingsVersion]    BINARY (8) DEFAULT ((0)) NOT NULL;


GO
PRINT N'Creating [dbo].[RowVersionSequence]...';


GO
CREATE TABLE [dbo].[RowVersionSequence] (
    [IsDummy] BIT        NOT NULL,
    [Version] ROWVERSION NOT NULL,
    PRIMARY KEY CLUSTERED ([IsDummy] ASC)
);


GO
PRINT N'Altering [dbo].[GetSchemaVersion]...';


GO
ALTER PROCEDURE [dbo].[GetSchemaVersion] AS RETURN 1
GO
PRINT N'Creating [dbo].[GetNextValueForSequence]...';


GO
CREATE PROCEDURE [dbo].[GetNextValueForSequence]
(
	@nextValue BINARY(8) OUTPUT
)
AS
DECLARE @outTable TABLE (outValue BINARY(8))
UPDATE [dbo].[RowVersionSequence] SET IsDummy=1 OUTPUT CAST(Deleted.Version AS BINARY(8)) AS VERSION INTO @outTable
IF (@@ROWCOUNT = 0) 
BEGIN
	BEGIN TRY
		INSERT INTO [dbo].[RowVersionSequence] (IsDummy) VALUES (1)
	END TRY
	BEGIN CATCH
		IF (ERROR_NUMBER() <> 2627)
		BEGIN
			DECLARE @ErrorMessage nvarchar(MAX), @ErrorSeverity INT, @ErrorState INT;
			SELECT @ErrorMessage = ERROR_MESSAGE() + ' Line ' + CAST(ERROR_LINE() AS nvarchar(5)), @ErrorSeverity = ERROR_SEVERITY(), @ErrorState = ERROR_STATE();
			raiserror (@ErrorMessage, @ErrorSeverity, @ErrorState);
		END
	END CATCH;
	UPDATE [dbo].[RowVersionSequence] SET IsDummy=1 OUTPUT CAST(Deleted.Version AS INT) AS VERSION INTO @outTable
END
SET @nextValue = (SELECT outValue FROM @outTable)
RETURN 0
GO
PRINT N'Creating [dbo].[ClientSettings_Versions_I]...';


GO
CREATE TRIGGER [dbo].[ClientSettings_Versions_I]
	ON [dbo].[ClientSettings]
	AFTER INSERT
	AS
	BEGIN
		SET NOCOUNT ON
		DECLARE @nextValue BINARY(8)
		EXEC GetNextValueForSequence @nextValue OUTPUT
		UPDATE [dbo].[ClientSettings] SET MenuVersion=@nextValue, WorkDetectorRulesVersion=@nextValue, CensorRulesVersion=@nextValue, ClientSettingsVersion=@nextValue WHERE UserId IN (SELECT UserId FROM inserted)
	END
GO
PRINT N'Creating [dbo].[ClientSettings_Versions_U]...';


GO
CREATE TRIGGER [dbo].[ClientSettings_Versions_U]
	ON [dbo].[ClientSettings]
	AFTER UPDATE
	AS
	BEGIN
		SET NOCOUNT ON
		DECLARE @nextValue BINARY(8)
		EXEC GetNextValueForSequence @nextValue OUTPUT
		IF ( UPDATE (Menu) ) 
		BEGIN
			UPDATE [ClientSettings] SET MenuVersion = @nextValue WHERE UserId IN (SELECT i.UserId FROM inserted i JOIN deleted d ON i.UserId = d.UserId WHERE i.Menu <> d.Menu OR (i.Menu IS NOT NULL AND d.Menu IS NULL) OR (i.Menu IS NULL AND d.Menu IS NOT NULL))
		END
		IF ( UPDATE (WorkDetectorRules) ) 
		BEGIN
			UPDATE [ClientSettings] SET WorkDetectorRulesVersion = @nextValue WHERE UserId IN (SELECT i.UserId FROM inserted i JOIN deleted d ON i.UserId = d.UserId WHERE i.WorkDetectorRules <> d.WorkDetectorRules OR (i.WorkDetectorRules IS NOT NULL AND d.WorkDetectorRules IS NULL) OR (i.WorkDetectorRules IS NULL AND d.WorkDetectorRules IS NOT NULL))
		END
		IF ( UPDATE (CensorRules) ) 
		BEGIN
			UPDATE [ClientSettings] SET CensorRulesVersion = @nextValue WHERE UserId IN (SELECT i.UserId FROM inserted i JOIN deleted d ON i.UserId = d.UserId WHERE i.CensorRules <> d.CensorRules OR (i.CensorRules IS NOT NULL AND d.CensorRules IS NULL) OR (i.CensorRules IS NULL AND d.CensorRules IS NOT NULL))
		END
		IF (UPDATE(MenuUpdateInterval) OR UPDATE(CaptureWorkItemInterval) OR UPDATE(CaptureActiveWindowInterval) OR UPDATE(CaptureScreenShotInterval)
			OR UPDATE(TimeSyncThreshold) OR UPDATE(JpegQuality) OR UPDATE(JpegScalePct) OR UPDATE(WorkTimeStartInMins)
			OR UPDATE(WorkTimeEndInMins) OR UPDATE(AfterWorkTimeIdleInMins) OR UPDATE(MaxOfflineWorkItems) OR UPDATE(DuringWorkTimeIdleInMins)
			OR UPDATE(DuringWorkTimeIdleManualInterval) OR UPDATE(MaxManualMeetingInterval) OR UPDATE(RuleRestrictions) OR UPDATE(IsMeetingTrackingEnabled)
			OR UPDATE(IsMeetingSubjectMandatory) OR UPDATE(BusyTimeThreshold) OR UPDATE(CoincidentalClientsEnabled) OR UPDATE(IsManualMeetingStartsOnLock)
			OR UPDATE(IsLotusNotesMeetingTrackingEnabled) OR UPDATE(RuleMatchingInterval))
		BEGIN
			UPDATE [ClientSettings] SET ClientSettingsVersion = @nextValue 
			WHERE UserId IN 
			(
				SELECT i.UserId FROM inserted i JOIN deleted d ON i.UserId = d.UserId 
				WHERE i.MenuUpdateInterval <> d.MenuUpdateInterval OR (i.MenuUpdateInterval IS NOT NULL AND d.MenuUpdateInterval IS NULL) OR (i.MenuUpdateInterval IS NULL AND d.MenuUpdateInterval IS NOT NULL)
				OR i.CaptureWorkItemInterval <> d.CaptureWorkItemInterval OR (i.CaptureWorkItemInterval IS NOT NULL AND d.CaptureWorkItemInterval IS NULL) OR (i.CaptureWorkItemInterval IS NULL AND d.CaptureWorkItemInterval IS NOT NULL)
				OR i.CaptureActiveWindowInterval <> d.CaptureActiveWindowInterval OR (i.CaptureActiveWindowInterval IS NOT NULL AND d.CaptureActiveWindowInterval IS NULL) OR (i.CaptureActiveWindowInterval IS NULL AND d.CaptureActiveWindowInterval IS NOT NULL)
				OR i.CaptureScreenShotInterval <> d.CaptureScreenShotInterval OR (i.CaptureScreenShotInterval IS NOT NULL AND d.CaptureScreenShotInterval IS NULL) OR (i.CaptureScreenShotInterval IS NULL AND d.CaptureScreenShotInterval IS NOT NULL)
				OR i.TimeSyncThreshold <> d.TimeSyncThreshold OR (i.TimeSyncThreshold IS NOT NULL AND d.TimeSyncThreshold IS NULL) OR (i.TimeSyncThreshold IS NULL AND d.TimeSyncThreshold IS NOT NULL)
				OR i.JpegQuality <> d.JpegQuality OR (i.JpegQuality IS NOT NULL AND d.JpegQuality IS NULL) OR (i.JpegQuality IS NULL AND d.JpegQuality IS NOT NULL)
				OR i.JpegScalePct <> d.JpegScalePct OR (i.JpegScalePct IS NOT NULL AND d.JpegScalePct IS NULL) OR (i.JpegScalePct IS NULL AND d.JpegScalePct IS NOT NULL)
				OR i.WorkTimeStartInMins <> d.WorkTimeStartInMins OR (i.WorkTimeStartInMins IS NOT NULL AND d.WorkTimeStartInMins IS NULL) OR (i.WorkTimeStartInMins IS NULL AND d.WorkTimeStartInMins IS NOT NULL)
				OR i.WorkTimeEndInMins <> d.WorkTimeEndInMins OR (i.WorkTimeEndInMins IS NOT NULL AND d.WorkTimeEndInMins IS NULL) OR (i.WorkTimeEndInMins IS NULL AND d.WorkTimeEndInMins IS NOT NULL)
				OR i.AfterWorkTimeIdleInMins <> d.AfterWorkTimeIdleInMins OR (i.AfterWorkTimeIdleInMins IS NOT NULL AND d.AfterWorkTimeIdleInMins IS NULL) OR (i.AfterWorkTimeIdleInMins IS NULL AND d.AfterWorkTimeIdleInMins IS NOT NULL)
				OR i.MaxOfflineWorkItems <> d.MaxOfflineWorkItems OR (i.MaxOfflineWorkItems IS NOT NULL AND d.MaxOfflineWorkItems IS NULL) OR (i.MaxOfflineWorkItems IS NULL AND d.MaxOfflineWorkItems IS NOT NULL)
				OR i.DuringWorkTimeIdleInMins <> d.DuringWorkTimeIdleInMins OR (i.DuringWorkTimeIdleInMins IS NOT NULL AND d.DuringWorkTimeIdleInMins IS NULL) OR (i.DuringWorkTimeIdleInMins IS NULL AND d.DuringWorkTimeIdleInMins IS NOT NULL)
				OR i.DuringWorkTimeIdleManualInterval <> d.DuringWorkTimeIdleManualInterval OR (i.DuringWorkTimeIdleManualInterval IS NOT NULL AND d.DuringWorkTimeIdleManualInterval IS NULL) OR (i.DuringWorkTimeIdleManualInterval IS NULL AND d.DuringWorkTimeIdleManualInterval IS NOT NULL)
				OR i.MaxManualMeetingInterval <> d.MaxManualMeetingInterval OR (i.MaxManualMeetingInterval IS NOT NULL AND d.MaxManualMeetingInterval IS NULL) OR (i.MaxManualMeetingInterval IS NULL AND d.MaxManualMeetingInterval IS NOT NULL)
				OR i.RuleRestrictions <> d.RuleRestrictions OR (i.RuleRestrictions IS NOT NULL AND d.RuleRestrictions IS NULL) OR (i.RuleRestrictions IS NULL AND d.RuleRestrictions IS NOT NULL)
				OR i.IsMeetingTrackingEnabled <> d.IsMeetingTrackingEnabled OR (i.IsMeetingTrackingEnabled IS NOT NULL AND d.IsMeetingTrackingEnabled IS NULL) OR (i.IsMeetingTrackingEnabled IS NULL AND d.IsMeetingTrackingEnabled IS NOT NULL)
				OR i.IsMeetingSubjectMandatory <> d.IsMeetingSubjectMandatory OR (i.IsMeetingSubjectMandatory IS NOT NULL AND d.IsMeetingSubjectMandatory IS NULL) OR (i.IsMeetingSubjectMandatory IS NULL AND d.IsMeetingSubjectMandatory IS NOT NULL)
				OR i.BusyTimeThreshold <> d.BusyTimeThreshold OR (i.BusyTimeThreshold IS NOT NULL AND d.BusyTimeThreshold IS NULL) OR (i.BusyTimeThreshold IS NULL AND d.BusyTimeThreshold IS NOT NULL)
				OR i.CoincidentalClientsEnabled <> d.CoincidentalClientsEnabled OR (i.CoincidentalClientsEnabled IS NOT NULL AND d.CoincidentalClientsEnabled IS NULL) OR (i.CoincidentalClientsEnabled IS NULL AND d.CoincidentalClientsEnabled IS NOT NULL)
				OR i.IsManualMeetingStartsOnLock <> d.IsManualMeetingStartsOnLock OR (i.IsManualMeetingStartsOnLock IS NOT NULL AND d.IsManualMeetingStartsOnLock IS NULL) OR (i.IsManualMeetingStartsOnLock IS NULL AND d.IsManualMeetingStartsOnLock IS NOT NULL)
				OR i.IsLotusNotesMeetingTrackingEnabled <> d.IsLotusNotesMeetingTrackingEnabled OR (i.IsLotusNotesMeetingTrackingEnabled IS NOT NULL AND d.IsLotusNotesMeetingTrackingEnabled IS NULL) OR (i.IsLotusNotesMeetingTrackingEnabled IS NULL AND d.IsLotusNotesMeetingTrackingEnabled IS NOT NULL)
				OR i.RuleMatchingInterval <> d.RuleMatchingInterval OR (i.RuleMatchingInterval IS NOT NULL AND d.RuleMatchingInterval IS NULL) OR (i.RuleMatchingInterval IS NULL AND d.RuleMatchingInterval IS NOT NULL)
			)
		END
	END
GO
PRINT N'Update complete.';


GO
