/*
Deployment script for recorder

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
/*
:setvar DatabaseName "recorder"
:setvar DefaultFilePrefix "recorder"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""
*/

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating [dbo].[CollectedItemsDataType]...';


GO
CREATE TYPE [dbo].[CollectedItemsDataType] AS TABLE (
    [UserId]     INT             NULL,
    [CreateDate] DATETIME        NULL,
    [ComputerId] INT             NULL,
    [KeyId]      INT             NULL,
    [ValueId]    INT             NULL,
    [Key]        NVARCHAR (4000) NULL,
    [Value]      NVARCHAR (4000) NULL);


GO
PRINT N'Altering [dbo].[GetSchemaVersion]...';


GO
-- Don't modify this file, it's used in the build process!
ALTER PROCEDURE [dbo].[GetSchemaVersion]
AS RETURN 30
GO
PRINT N'Creating [dbo].[GetIdForCollectedKeyHard]...';


GO
Create PROCEDURE [dbo].[GetIdForCollectedKeyHard]
	(
	@key nvarchar(4000),
	@id int OUTPUT
	)
AS
	SET NOCOUNT ON
	SET XACT_ABORT ON

	IF @key IS NULL
	BEGIN
		RAISERROR('@@key cannot be NULL', 16, 1)
		RETURN
	END

declare @hashCode int
SET @hashCode = CHECKSUM(@key)

BEGIN TRAN

SET @id = (
	SELECT TOP 1 [Id]
	  FROM [dbo].[CollectedKeyLookup] WITH (TABLOCKX, HOLDLOCK)
	 WHERE [HashCode] = @hashCode
	   AND [Key] = @key
	)

IF @id IS NULL
BEGIN
	INSERT INTO [dbo].[CollectedKeyLookup]
			   ([HashCode]
			   ,[Key])
		 VALUES
			   (@hashCode
			   ,@key)

	SET @id = SCOPE_IDENTITY()
END

COMMIT TRAN

	RETURN
GO
PRINT N'Creating [dbo].[GetIdForCollectedKeyLight]...';


GO
Create PROCEDURE [dbo].[GetIdForCollectedKeyLight]
	(
	@Items [dbo].[CollectedItemsDataType] Readonly
	)
AS
	SET NOCOUNT ON
	SET XACT_ABORT ON


SELECT lup.[Id], items.[Key]
 FROM [dbo].[CollectedKeyLookup] as lup, @Items as items
	 WHERE lup.[HashCode] = CHECKSUM(items.[Key])
  AND lup.[Key] = items.[Key]


	RETURN
GO
PRINT N'Creating [dbo].[GetIdForCollectedValueHard]...';


GO
Create PROCEDURE [dbo].[GetIdForCollectedValueHard]
	(
	@value nvarchar(4000),
	@id int OUTPUT
	)
AS
	SET NOCOUNT ON
	SET XACT_ABORT ON

	IF @value IS NULL
	BEGIN
		RAISERROR('@value cannot be NULL', 16, 1)
		RETURN
	END

declare @hashCode int
SET @hashCode = CHECKSUM(@value)


BEGIN TRAN

SELECT @id = [Id]
 FROM [dbo].[CollectedValueLookup]
WHERE [HashCode] = @hashCode
  AND [Value] = @value

IF @id IS NULL
BEGIN
	INSERT INTO [dbo].[CollectedValueLookup]
			   ([HashCode]
			   ,[Value])
		 VALUES
			   (@hashCode
			   ,@value)

	SET @id = SCOPE_IDENTITY()
END

COMMIT TRAN

	RETURN
GO
PRINT N'Creating [dbo].[GetIdForCollectedValueLight]...';


GO
Create PROCEDURE [dbo].[GetIdForCollectedValueLight]
	(
	@Items [dbo].[CollectedItemsDataType] Readonly
	)
AS
	SET NOCOUNT ON
	SET XACT_ABORT ON


	SELECT lup.[Id], items.[Value]
 FROM [dbo].[CollectedValueLookup] as lup, @Items as items
	 WHERE lup.[HashCode] = CHECKSUM(items.[Value])
  AND lup.[Value] = items.[Value]


	RETURN
GO
PRINT N'Creating [dbo].[InsertCollectedItems]...';


GO
CREATE PROCEDURE [dbo].[InsertCollectedItems]
(
	@CollectedItems As [dbo].[CollectedItemsDataType] Readonly
)
AS
BEGIN
	SET NOCOUNT ON;
	SET XACT_ABORT ON

	INSERT INTO [dbo].[CollectedItems]
			   ([UserId]
			   ,[CreateDate]
			   ,[ComputerId]
			   ,[KeyId]
			   ,[ValueId])
		 SELECT
			   [UserId]
			   ,[CreateDate]
			   ,[ComputerId]
			   ,[KeyId]
			   ,[ValueId]
		FROM
				@CollectedItems 

END

GO
PRINT N'Dropping [dbo].[InsertCollectedItem]...';

GO
DROP PROCEDURE [dbo].[InsertCollectedItem]

GO
PRINT N'Dropping [dbo].[GetIdForCollectedKey]...';

GO
DROP PROCEDURE [dbo].[GetIdForCollectedKey]

GO
PRINT N'Dropping [dbo].[GetIdForCollectedValue]...';

GO
DROP PROCEDURE [dbo].[GetIdForCollectedValue]

GO
PRINT N'Update complete.';


GO
