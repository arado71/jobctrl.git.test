/*
Deployment script for recorder

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
/*
:setvar DatabaseName "recorder"
:setvar DefaultFilePrefix "recorder"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""
*/

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Altering [dbo].[GetIdForProcessName]...';


GO
-- =============================================
-- Author: Zoltan Torok
-- =============================================
ALTER PROCEDURE [dbo].[GetIdForProcessName]
	(
	@processName nvarchar(100),
	@id int OUTPUT
	)
AS
	SET NOCOUNT ON
	SET XACT_ABORT ON

	IF @processName IS NULL
	BEGIN
		RAISERROR('@processName cannot be NULL', 16, 1)
		RETURN
	END

declare @hashCode int
SET @hashCode = CHECKSUM(@processName)

--optimize for common case, we don't want to put index on (hash,value) or handle deadlocks so we won't use UPDLOCK
	SELECT @id = [Id]
	  FROM [dbo].[ProcessNameLookup]
	 WHERE [HashCode] = @hashCode
	   AND [ProcessName] = @processName

IF @id IS NOT NULL
	RETURN

INSERT INTO [dbo].[ProcessNameLookup]
		   ([HashCode]
		   ,[ProcessName])
	 VALUES
		   (@hashCode
		   ,@processName)

SET @id = SCOPE_IDENTITY()

RETURN
GO
PRINT N'Altering [dbo].[GetIdForTitle]...';


GO
-- =============================================
-- Author: Zoltan Torok
-- =============================================
ALTER PROCEDURE [dbo].[GetIdForTitle]
	(
	@title nvarchar(1000),
	@id int OUTPUT
	)
AS
	SET NOCOUNT ON
	SET XACT_ABORT ON

	IF @title IS NULL
	BEGIN
		RAISERROR('@title cannot be NULL', 16, 1)
		RETURN
	END

declare @hashCode int
SET @hashCode = CHECKSUM(@title)

--optimize for common case, we don't want to put index on (hash,value) or handle deadlocks so we won't use UPDLOCK
	SELECT @id = [Id]
	  FROM [dbo].[TitleLookup]
	 WHERE [HashCode] = @hashCode
	   AND [Title] = @title

IF @id IS NOT NULL
	RETURN

INSERT INTO [dbo].[TitleLookup]
		   ([HashCode]
		   ,[Title])
	 VALUES
		   (@hashCode
		   ,@title)

SET @id = SCOPE_IDENTITY()

RETURN
GO
PRINT N'Altering [dbo].[GetIdForUrl]...';


GO
-- =============================================
-- Author: Zoltan Torok
-- =============================================
ALTER PROCEDURE [dbo].[GetIdForUrl]
	(
	@url nvarchar(1000),
	@id int OUTPUT
	)
AS
	SET NOCOUNT ON
	SET XACT_ABORT ON

	IF @url IS NULL
	BEGIN
		RAISERROR('@url cannot be NULL', 16, 1)
		RETURN
	END

declare @hashCode int
SET @hashCode = CHECKSUM(@url)

--optimize for common case, we don't want to put index on (hash,value) or handle deadlocks so we won't use UPDLOCK
	SELECT @id = [Id]
	  FROM [dbo].[UrlLookup]
	 WHERE [HashCode] = @hashCode
	   AND [Url] = @url

IF @id IS NOT NULL
	RETURN

INSERT INTO [dbo].[UrlLookup]
		   ([HashCode]
		   ,[Url])
	 VALUES
		   (@hashCode
		   ,@url)

SET @id = SCOPE_IDENTITY()

RETURN
GO
PRINT N'Altering [dbo].[GetSchemaVersion]...';


GO
-- Don't modify this file, it's used in the build process!
ALTER PROCEDURE [dbo].[GetSchemaVersion]
AS RETURN 12
GO
PRINT N'Refreshing [dbo].[InsertDesktopWindow]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[InsertDesktopWindow]';


GO
PRINT N'Update complete.';


GO
