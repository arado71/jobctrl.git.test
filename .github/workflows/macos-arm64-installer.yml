name: macOS arm64 pkg (pack.sh)

on:
  push:
    tags:
      - "macos-v*"

permissions:
  contents: read

jobs:
  build-sign-notarize:
    runs-on: macos-15

    env:
      PROJECT_DIR: ActivityRecorderClient.Avalonia.Mac
      PACK_SCRIPT: ActivityRecorderClient.Avalonia.Mac/pack.sh

      # pack.sh ezt a profilt hasznÃ¡lja:
      NOTARY_PROFILE: JC360_NOTARY

      # Apple notarization
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          ref="${GITHUB_REF#refs/tags/}"
          ver="${ref#macos-v}"

          if [[ ! "$ver" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Tag version must be a.b.c.d, got: $ver"
            exit 1
          fi

          echo "buildVersion=$ver" >> "$GITHUB_OUTPUT"
          echo "Using buildVersion=$ver"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore required .NET workloads (with .NET 8)
        shell: bash
        run: |
          set -euo pipefail
          dotnet --version
          dotnet workload install macos wasm-tools
          
      - name: Import signing certificates into keychain (App + Installer)
        shell: bash
        run: |
          set -euo pipefail

          KEYCHAIN=build.keychain
          security create-keychain -p "" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "" "$KEYCHAIN"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN"

          echo "${MACOS_APP_CERT_P12_BASE64}" | base64 --decode > app_cert.p12
          security import app_cert.p12 -k "$KEYCHAIN" -P "${MACOS_APP_CERT_P12_PASSWORD}" \
            -T /usr/bin/codesign

          echo "${MACOS_INSTALLER_CERT_P12_BASE64}" | base64 --decode > installer_cert.p12
          security import installer_cert.p12 -k "$KEYCHAIN" -P "${MACOS_INSTALLER_CERT_P12_PASSWORD}" \
            -T /usr/bin/productsign -T /usr/bin/pkgbuild

          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN"

        env:
          MACOS_APP_CERT_P12_BASE64: ${{ secrets.MACOS_APP_CERT_P12_BASE64 }}
          MACOS_APP_CERT_P12_PASSWORD: ${{ secrets.MACOS_APP_CERT_P12_PASSWORD }}
          MACOS_INSTALLER_CERT_P12_BASE64: ${{ secrets.MACOS_INSTALLER_CERT_P12_BASE64 }}
          MACOS_INSTALLER_CERT_P12_PASSWORD: ${{ secrets.MACOS_INSTALLER_CERT_P12_PASSWORD }}

      - name: Create notarytool keychain profile (JC360_NOTARY)
        shell: bash
        run: |
          set -euo pipefail
          xcrun notarytool store-credentials "${NOTARY_PROFILE}" \
            --apple-id "${APPLE_ID}" \
            --password "${APPLE_APP_PASSWORD}" \
            --team-id "${APPLE_TEAM_ID}"

      - name: Make pack.sh executable
        shell: bash
        run: |
          set -euo pipefail
          chmod +x "${PACK_SCRIPT}"

      - name: Build + sign + pkg + notarize (arm64)
        shell: bash
        working-directory: ActivityRecorderClient.Avalonia.Mac
        run: |
          set -euo pipefail
          export APP_VERSION_OVERRIDE="${{ steps.ver.outputs.buildVersion }}"
          ./pack.sh arm64
          
      - name: Upload artifact (signed pkg)
        uses: actions/upload-artifact@v4
        with:
          name: JC360-osx-arm64-signed-${{ steps.ver.outputs.buildVersion }}
          path: ActivityRecorderClient.Avalonia.Mac/bin/Release/net8.0-macos/osx-arm64/publish/JC360-osx-arm64-signed.pkg

      - name: Publish GitHub Release asset (no zip)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
          FILE: ActivityRecorderClient.Avalonia.Mac/bin/Release/net8.0-macos/osx-arm64/publish/JC360-osx-arm64-signed.pkg
        run: |
          set -euo pipefail

          if [[ ! -f "$FILE" ]]; then
            echo "ERROR: File not found: $FILE"
            exit 1
          fi

          echo "Ensuring release exists for tag: $TAG"
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "$TAG" --notes "Automated build for $TAG"
          fi

          echo "Uploading asset (overwrite if exists): $FILE"
          gh release upload "$TAG" "$FILE" --clobber