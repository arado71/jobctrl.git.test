name: macOS pkg (pack.sh matrix)

on:
  push:
    tags:
      - "macos-v*"

permissions:
  contents: write

jobs:
  build-sign-notarize:
    runs-on: macos-15

    env:
      NOTARY_PROFILE: JC360_NOTARY

      # Apple notarization
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          ref="${GITHUB_REF#refs/tags/}"
          ver="${ref#macos-v}"

          if [[ ! "$ver" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Tag version must be a.b.c.d, got: $ver"
            exit 1
          fi

          echo "buildVersion=$ver" >> "$GITHUB_OUTPUT"
          echo "Using buildVersion=$ver"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore required .NET workloads (with .NET 8)
        shell: bash
        run: |
          set -euo pipefail
          dotnet --version
          dotnet workload install macos wasm-tools
          
      - name: Import signing certificates into keychain (App + Installer)
        shell: bash
        env:
          MACOS_APP_CERT_P12_BASE64: ${{ secrets.MACOS_APP_CERT_P12_BASE64 }}
          MACOS_APP_CERT_P12_PASSWORD: ${{ secrets.MACOS_APP_CERT_P12_PASSWORD }}
          MACOS_INSTALLER_CERT_P12_BASE64: ${{ secrets.MACOS_INSTALLER_CERT_P12_BASE64 }}
          MACOS_INSTALLER_CERT_P12_PASSWORD: ${{ secrets.MACOS_INSTALLER_CERT_P12_PASSWORD }}
        run: |
          set -euo pipefail

          KEYCHAIN="$RUNNER_TEMP/jc360-build.keychain"
          security create-keychain -p "" "$KEYCHAIN"
          security unlock-keychain -p "" "$KEYCHAIN"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN"

          security list-keychains -d user -s "$KEYCHAIN"
          security default-keychain -d user -s "$KEYCHAIN"

          echo "$MACOS_APP_CERT_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/app_cert.p12"
          security import "$RUNNER_TEMP/app_cert.p12" -k "$KEYCHAIN" -P "$MACOS_APP_CERT_P12_PASSWORD" \
            -T /usr/bin/codesign

          echo "$MACOS_INSTALLER_CERT_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/installer_cert.p12"
          security import "$RUNNER_TEMP/installer_cert.p12" -k "$KEYCHAIN" -P "$MACOS_INSTALLER_CERT_P12_PASSWORD" \
            -T /usr/bin/pkgbuild -T /usr/bin/productsign

          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN"

      - name: Create notarytool keychain profile (JC360_NOTARY)
        shell: bash
        run: |
          set -euo pipefail
          xcrun notarytool store-credentials "${NOTARY_PROFILE}" \
            --apple-id "${APPLE_ID}" \
            --password "${APPLE_APP_PASSWORD}" \
            --team-id "${APPLE_TEAM_ID}"

      - name: Build all packages (arm64/x64 Ã— Default/Brasil)
        shell: bash
        working-directory: ActivityRecorderClient.Avalonia.Mac
        run: |
          set -euo pipefail
          chmod +x ./pack.sh

          export APP_VERSION_OVERRIDE="${{ steps.ver.outputs.buildVersion }}"

          ./pack.sh arm64 Default
          ./pack.sh arm64 Brasil
          ./pack.sh x64 Default
          ./pack.sh x64 Brasil

      - name: Collect generated pkgs
        id: collect
        shell: bash
        run: |
          set -euo pipefail

          OUTDIR="$RUNNER_TEMP/pkgs"
          mkdir -p "$OUTDIR"

          for arch in arm64 x64; do
            for cfg in Default Brasil; do
              pub="ActivityRecorderClient.Avalonia.Mac/bin/Release/net8.0-macos/osx-${arch}/publish"
              file="JC360-osx-${arch}-${cfg}.pkg"

              if [[ ! -f "${pub}/${file}" ]]; then
                echo "ERROR: Missing ${pub}/${file}"
                echo "Contents of ${pub}:"
                ls -la "${pub}" || true
                exit 1
              fi

              cp -f "${pub}/${file}" "$OUTDIR/"
            done
          done

          ls -la "$OUTDIR"
          echo "outdir=$OUTDIR" >> "$GITHUB_OUTPUT"

      - name: Ensure GitHub Release exists
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "$TAG" --notes "Automated build for $TAG"
          fi

      - name: Upload all pkgs to Release assets (no zip)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          OUTDIR="${{ steps.collect.outputs.outdir }}"
          gh release upload "$TAG" \
            "$OUTDIR/JC360-osx-arm64-Default.pkg" \
            "$OUTDIR/JC360-osx-arm64-Brasil.pkg" \
            "$OUTDIR/JC360-osx-x64-Default.pkg" \
            "$OUTDIR/JC360-osx-x64-Brasil.pkg" \
            --clobber